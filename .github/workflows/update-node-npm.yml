# Workflow to automatically detect new Node.js LTS versions and create a PR to update the project

# Requirements:
# - Secret `PAT_WORKFLOW` must be configured:
#   1. Create a Personal Access Token (PAT) in GitHub:
#      ‚Üí Profile ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)
#      ‚Üí Generate new token with `repo` and `workflow` permissions
#   2. Add the token as a repository secret:
#      ‚Üí Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
#      ‚Üí Name: PAT_WORKFLOW, Value: (paste the token)

# Files updated by this workflow:
# - .nvmrc
# - package.json (engines.node and engines.npm)
# - .github/workflows/check-node.yml (matrix node-version)

# Optional configuration file (.noderc.json):
# {
#   "maxMajorVersion": 22  // Limits updates to this major version (receives minor/patch only)
# }
# If the file doesn't exist, the workflow will update to the latest LTS version.

name: üì¶ Create PR to update Node and NPM versions

on:
  schedule:
    # Monthly: First Saturday at 09:00 Spain (08:00 UTC)
    # Runs on days 1-7 of each month, but only if it's Saturday (day 6)
    - cron: "0 8 1-7 * 6"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-node:
    name: üîç Check and update Node.js version
    runs-on: ubuntu-latest

    steps:
      - name: üîÄ Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üìã Read configuration
        id: config
        run: |
          # Check if .noderc.json exists
          if [ -f .noderc.json ]; then
            echo "üìÑ Configuration file found"
            MAX_MAJOR=$(jq -r '.maxMajorVersion // empty' .noderc.json)
            if [ -n "$MAX_MAJOR" ]; then
              echo "üîí Max major version configured: $MAX_MAJOR"
              echo "has_config=true" >> $GITHUB_OUTPUT
              echo "max_major=$MAX_MAJOR" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Configuration file exists but maxMajorVersion not set"
              echo "has_config=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "üìÑ No configuration file found, using latest LTS"
            echo "has_config=false" >> $GITHUB_OUTPUT
          fi

      - name: üåê Get Node.js LTS versions info
        id: node-versions
        run: |
          # Fetch Node.js release schedule
          RELEASES=$(curl -s https://raw.githubusercontent.com/nodejs/Release/main/schedule.json)

          # Fetch all Node.js versions
          ALL_VERSIONS=$(curl -s https://nodejs.org/dist/index.json)

          # Get current date
          CURRENT_DATE=$(date +%Y-%m-%d)

          # Check if maxMajorVersion is configured
          HAS_CONFIG="${{ steps.config.outputs.has_config }}"
          MAX_MAJOR="${{ steps.config.outputs.max_major }}"

          if [ "$HAS_CONFIG" == "true" ]; then
            echo "üîí Using configured max major version: $MAX_MAJOR"
            TARGET_MAJOR=$MAX_MAJOR

            # For matrix, find the previous LTS version
            ACTIVE_LTS=$(echo "$RELEASES" | jq -r --arg date "$CURRENT_DATE" --argjson max "$MAX_MAJOR" '
              to_entries |
              map(select(
                .value.start <= $date and
                .value.end >= $date and
                .value.lts != null and
                .value.lts <= $date and
                (.key | ltrimstr("v") | tonumber) <= $max
              )) |
              map(.key | ltrimstr("v") | tonumber) |
              sort |
              .[-2:]
            ')

            LTS_OLDEST=$(echo "$ACTIVE_LTS" | jq '.[0]')
            LTS_LATEST=$(echo "$ACTIVE_LTS" | jq '.[1] // .[0]')

            # If only one version in array, use it for both
            if [ "$LTS_LATEST" == "null" ] || [ -z "$LTS_LATEST" ]; then
              LTS_LATEST=$LTS_OLDEST
            fi
          else
            echo "üì¶ Using latest LTS version (no config)"

            # Find active LTS versions (started and not ended)
            ACTIVE_LTS=$(echo "$RELEASES" | jq -r --arg date "$CURRENT_DATE" '
              to_entries |
              map(select(
                .value.start <= $date and
                .value.end >= $date and
                .value.lts != null and
                .value.lts <= $date
              )) |
              map(.key | ltrimstr("v") | tonumber) |
              sort |
              .[-2:]
            ')

            LTS_OLDEST=$(echo "$ACTIVE_LTS" | jq '.[0]')
            LTS_LATEST=$(echo "$ACTIVE_LTS" | jq '.[1]')
            TARGET_MAJOR=$LTS_LATEST
          fi

          echo "Active LTS versions: $ACTIVE_LTS"
          echo "LTS oldest: $LTS_OLDEST"
          echo "LTS latest: $LTS_LATEST"
          echo "Target major: $TARGET_MAJOR"

          # Get the latest version of the target major
          LATEST_VERSION=$(echo "$ALL_VERSIONS" | jq -r --argjson major "$TARGET_MAJOR" '
            map(select(.version | startswith("v\($major)."))) |
            .[0].version |
            ltrimstr("v")
          ')

          echo "Latest version for major $TARGET_MAJOR: $LATEST_VERSION"

          # Get npm version bundled with this Node version
          NPM_VERSION=$(echo "$ALL_VERSIONS" | jq -r --arg ver "v$LATEST_VERSION" '
            map(select(.version == $ver)) |
            .[0].npm
          ')

          echo "Bundled npm version: $NPM_VERSION"

          # Set outputs
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          echo "lts_oldest=$LTS_OLDEST" >> $GITHUB_OUTPUT
          echo "lts_latest=$LTS_LATEST" >> $GITHUB_OUTPUT
          echo "matrix=[ $LTS_OLDEST, $LTS_LATEST ]" >> $GITHUB_OUTPUT
          echo "has_version_limit=$HAS_CONFIG" >> $GITHUB_OUTPUT

      - name: üìñ Get current versions
        id: current-versions
        run: |
          # Check if .nvmrc exists
          if [ ! -f .nvmrc ]; then
            echo "‚ùå .nvmrc file not found"
            echo "has_nvmrc=false" >> $GITHUB_OUTPUT
            echo "current_node=unknown" >> $GITHUB_OUTPUT
          else
            echo "has_nvmrc=true" >> $GITHUB_OUTPUT
            CURRENT_NODE=$(cat .nvmrc | tr -d 'v' | tr -d '\n')
            echo "Current Node version: $CURRENT_NODE"
            echo "current_node=$CURRENT_NODE" >> $GITHUB_OUTPUT
          fi

          # Check if package.json has engines.node
          if [ ! -f package.json ] || [ "$(jq -r '.engines.node // empty' package.json)" == "" ]; then
            echo "‚ùå package.json engines.node not found"
            echo "has_engines=false" >> $GITHUB_OUTPUT
            echo "current_npm=unknown" >> $GITHUB_OUTPUT
          else
            echo "has_engines=true" >> $GITHUB_OUTPUT
            CURRENT_NPM=$(jq -r '.engines.npm // "unknown"' package.json)
            echo "Current npm version: $CURRENT_NPM"
            echo "current_npm=$CURRENT_NPM" >> $GITHUB_OUTPUT
          fi

          # Check if check-node.yml exists and get current matrix
          if [ ! -f .github/workflows/check-node.yml ]; then
            echo "‚ùå check-node.yml workflow not found"
            echo "has_node_yml=false" >> $GITHUB_OUTPUT
            echo "current_matrix=unknown" >> $GITHUB_OUTPUT
          else
            echo "has_node_yml=true" >> $GITHUB_OUTPUT
            CURRENT_MATRIX=$(grep "node-version: \[" .github/workflows/check-node.yml | sed 's/.*node-version: //' | tr -d ' ')
            echo "Current matrix: $CURRENT_MATRIX"
            echo "current_matrix=$CURRENT_MATRIX" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ Check if update is needed
        id: check-update
        run: |
          LATEST="${{ steps.node-versions.outputs.latest_version }}"
          CURRENT="${{ steps.current-versions.outputs.current_node }}"

          # Get current date in DD-MM-YYYY format
          echo "date=$(date +%d-%m-%Y)" >> $GITHUB_OUTPUT

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "Update needed: $CURRENT -> $LATEST"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date: $CURRENT"
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: üìù Update .nvmrc
        if: steps.check-update.outputs.update_needed == 'true' && steps.current-versions.outputs.has_nvmrc == 'true'
        run: |
          echo "v${{ steps.node-versions.outputs.latest_version }}" > .nvmrc
          echo "Updated .nvmrc to v${{ steps.node-versions.outputs.latest_version }}"

      - name: üìù Update package.json engines
        if: steps.check-update.outputs.update_needed == 'true' && steps.current-versions.outputs.has_engines == 'true'
        run: |
          # Update node and npm versions preserving tab indentation
          jq --tab '.engines.node = "${{ steps.node-versions.outputs.latest_version }}" | .engines.npm = "${{ steps.node-versions.outputs.npm_version }}"' package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "Updated package.json engines"
          cat package.json | jq '.engines'

      - name: üìù Update check-node.yml matrix
        if: steps.check-update.outputs.update_needed == 'true' && steps.current-versions.outputs.has_node_yml == 'true'
        run: |
          # Update the node-version matrix in check-node.yml
          sed -i "s/node-version: \[.*\]/node-version: ${{ steps.node-versions.outputs.matrix }}/" .github/workflows/check-node.yml

          echo "Updated check-node.yml matrix"
          grep "node-version:" .github/workflows/check-node.yml

      - name: üöÄ Create Pull Request
        if: |
          steps.check-update.outputs.update_needed == 'true' &&
          (steps.current-versions.outputs.has_nvmrc == 'true' || steps.current-versions.outputs.has_engines == 'true' || steps.current-versions.outputs.has_node_yml == 'true')
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.PAT_WORKFLOW }}
          commit-message: |
            ci(deps): update `node@${{ steps.node-versions.outputs.latest_version }}` and `npm@${{ steps.node-versions.outputs.npm_version }}` versions

            Description:
            - Update `node` from `${{ steps.current-versions.outputs.current_node }}` to `${{ steps.node-versions.outputs.latest_version }}`
            - Update `npm` from `${{ steps.current-versions.outputs.current_npm }}` to `${{ steps.node-versions.outputs.npm_version }}`

            Steps:
            - Update `.nvmrc` file: v${{ steps.current-versions.outputs.current_node }} ‚Üí v${{ steps.node-versions.outputs.latest_version }}
            - Update `package.json` file in `engines.node`: ${{ steps.current-versions.outputs.current_node }} ‚Üí ${{ steps.node-versions.outputs.latest_version }}
            - Update `package.json` file in `engines.npm`: ${{ steps.current-versions.outputs.current_npm }} ‚Üí ${{ steps.node-versions.outputs.npm_version }}
            - Update `check-node.yml` file in matrix: ${{ steps.current-versions.outputs.current_matrix }} ‚Üí ${{ steps.node-versions.outputs.matrix }}
          title: "build(deps): update `node@${{ steps.node-versions.outputs.latest_version }}` and `npm@${{ steps.node-versions.outputs.npm_version }}` versions"
          body: |
            # build(deps): update `node@${{ steps.node-versions.outputs.latest_version }}` and `npm@${{ steps.node-versions.outputs.npm_version }}` versions

            | ‚è±Ô∏è Time | üìä Priority | üìè Size | üìÖ Date |
            |---------|-------------|---------|---------|
            | 5min    | P2          | XS      | ${{ steps.check-update.outputs.date }} |

            ## üîß Build Type
            - [x] Dependency update
            - [x] Build configuration
            - [x] CI/CD configuration

            ## üìù Description

            Automatic update of Node.js version detected by the `update-node-npm.yml` workflow.

            | Package | Previous | New |
            |---------|----------|-----|
            | `node` | `${{ steps.current-versions.outputs.current_node }}` | `${{ steps.node-versions.outputs.latest_version }}` |
            | `npm` | `${{ steps.current-versions.outputs.current_npm }}` | `${{ steps.node-versions.outputs.npm_version }}` |

            ## üìã Steps

            - Update `.nvmrc` file: `v${{ steps.current-versions.outputs.current_node }}` ‚Üí `v${{ steps.node-versions.outputs.latest_version }}`
            - Update `package.json` file in `engines.node`: `${{ steps.current-versions.outputs.current_node }}` ‚Üí `${{ steps.node-versions.outputs.latest_version }}`
            - Update `package.json` file in `engines.npm`: `${{ steps.current-versions.outputs.current_npm }}` ‚Üí `${{ steps.node-versions.outputs.npm_version }}`
            - Update `check-node.yml` file in matrix: `${{ steps.current-versions.outputs.current_matrix }}` ‚Üí `${{ steps.node-versions.outputs.matrix }}`

            ## üß™ Tests

            - [ ] Build completes successfully
            - [ ] All tests pass
            - [ ] Development workflow still works

            ## üîó References

            - [Node.js Release](https://nodejs.org/en/about/releases/)
            - Generated automatically by [update-node-npm.yml](./.github/workflows/update-node-npm.yml) workflow
          branch: dependabot/npm_and_yarn/node-${{ steps.node-versions.outputs.latest_version }}
          delete-branch: true
          labels: |
            github_actions
            dependencies
          assignees: beatrizsmerino

      - name: üìä Summary
        run: |
          # Set status badge
          if [ "${{ steps.check-update.outputs.update_needed }}" == "true" ]; then
            UPDATE_BADGE="![Update](https://img.shields.io/badge/Status-Update%20Available-yellow)"
          else
            UPDATE_BADGE="![Up to date](https://img.shields.io/badge/Status-Up%20to%20Date-green)"
          fi

          # Set version limit badge
          if [ "${{ steps.config.outputs.has_config }}" == "true" ]; then
            VERSION_LIMIT_BADGE="![Limited](https://img.shields.io/badge/Version%20Limit-v${{ steps.config.outputs.max_major }}-blue)"
            CONFIG_ICON="‚úÖ maxMajorVersion: ${{ steps.config.outputs.max_major }}"
          else
            VERSION_LIMIT_BADGE="![No Limit](https://img.shields.io/badge/Version%20Limit-None-gray)"
            CONFIG_ICON="‚ùå Not configured"
          fi

          if [ "${{ steps.current-versions.outputs.has_nvmrc }}" == "true" ]; then
            NVMRC_ICON="‚úÖ Found"
          else
            NVMRC_ICON="‚ùå Not found"
          fi

          if [ "${{ steps.current-versions.outputs.has_engines }}" == "true" ]; then
            ENGINES_ICON="‚úÖ Found"
          else
            ENGINES_ICON="‚ùå Not found"
          fi

          if [ "${{ steps.current-versions.outputs.has_node_yml }}" == "true" ]; then
            NODE_YML_ICON="‚úÖ Found"
          else
            NODE_YML_ICON="‚ùå Not found"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Node.js Update Check Summary

          ${UPDATE_BADGE} ${VERSION_LIMIT_BADGE}

          > üìÖ Last check: $(date +%d-%m-%Y)

          ## üî¢ Version Comparison

          | Package | Current | ‚Üí | Latest |
          |---------|:-------:|:-:|:------:|
          | **Node.js** | \`${{ steps.current-versions.outputs.current_node }}\` | ‚Üí | \`${{ steps.node-versions.outputs.latest_version }}\` |
          | **npm** | \`${{ steps.current-versions.outputs.current_npm }}\` | ‚Üí | \`${{ steps.node-versions.outputs.npm_version }}\` |
          | **CI Matrix** | \`${{ steps.current-versions.outputs.current_matrix }}\` | ‚Üí | \`${{ steps.node-versions.outputs.matrix }}\` |

          ## üìÅ Project Files

          | File | Status | Description |
          |------|:------:|-------------|
          | \`.noderc.json\` | ${CONFIG_ICON} | Version limit configuration |
          | \`.nvmrc\` | ${NVMRC_ICON} | Node version for nvm |
          | \`package.json\` | ${ENGINES_ICON} | Engines of node and npm |
          | \`check-node.yml\` | ${NODE_YML_ICON} | CI workflow matrix |

          ## üîó Resources

          - [Node.js Releases](https://nodejs.org/en/about/releases/)
          - [Node.js Changelog](https://github.com/nodejs/node/blob/main/CHANGELOG.md)
          - [NPM Releases](https://github.com/npm/cli/releases)
          - [NVM - Node Version Manager](https://github.com/nvm-sh/nvm)
          - [GitHub Actions setup-node](https://github.com/actions/setup-node?tab=readme-ov-file#matrix-testing)
          EOF
